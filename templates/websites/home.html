<!DOCTYPE html>
<html>
<head>
    <style>
        #top_container {
            background-color: #3B4B59;
        }
        #home{
            background-image: url("../../static/pexels-mikhail-nilov-6963098.jpg");
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body id="home">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="top_container">
        <div class="container-fluid">
            <a href="../" class="navbar-brand">密碼管理</a>
            <ul class="navbar-nav ms-auto">
                <form method="post">
                    <li class="nav-item">
                        <button class="btn btn-secondary ms-lg-2" type="submit" name="button_logout" value="button_logout">登出</button>
                    </li>
                </form>
            </ul>
        </div>
    </nav>
    <div class="container rounded-4" style="margin-top: 7rem;background-color: rgba(255, 255, 255, 0.5);padding: 3rem;">
        <div class="row">
            <div class="col-12">
                <h2>帳號密碼資訊</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <button type="button" class="btn btn-secondary" id="editButton" onclick="editUser()">編輯</button>
                <button type="submit" class="btn btn-secondary d-none" id="saveButton" onclick="saveUser()" value="button_complete" name="button_complete">完成</button>
                <button type="button" class="btn btn-secondary" id="addButton" onclick="addUser()">新增</button>
                <button type="button" class="btn btn-danger" id="deleteButton" onclick="deleteUser()" value="button_delete" name="button_delete">刪除</button>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <form id="userForm" method="post">
                    <table class="table rounded-4" id="dataTable" style="background-color: #fff;">
                        <thead>
                            <tr>
                                <th class="col-1"></th>
                                <th class="col-3">姓名</th>
                                <th class="col-4">帳號</th>
                                <th class="col-4">密碼</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 表格内容将通过 JavaScript 动态生成 -->
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
    </div>

    <!-- 模态框代码 -->
    <div class="modal fade" id="errorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">錯誤訊息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalErrorMessage">輸入欄位不得為空白</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var radioButtonStatus = false;
        window.addEventListener('DOMContentLoaded', (event) => {
            generateTable();
        });
        var jsonData = {{ user_info | tojson }};

        function generateTable() {
            // 获取表格的 tbody 元素
            var tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];

            for (var i = 0; i < jsonData.length; i++) {
                // 创建新的表格行
                var row = tableBody.insertRow(i);

                // 创建单元格并设置单元格内容
                var radioCell = row.insertCell(0);
                // 为第一个单元格的单选按钮添加属性 checked
                radioCell.innerHTML = '<input type="radio" name="keyword"' + (i === 0 ? 'checked' : '') + '>';

                var nameCell = row.insertCell(1);
                nameCell.innerHTML = '<span>' + jsonData[i].name + '</span><input type="text" class="form-control d-none" name="keyword">';

                var accountCell = row.insertCell(2);
                accountCell.innerHTML = '<span>' + jsonData[i].id + '</span><input type="text" class="form-control d-none" name="account_id">';

                var passwordCell = row.insertCell(3);
                passwordCell.innerHTML = '<span>' + jsonData[i].password + '</span><input type="text" class="form-control d-none" name="account_password">';
            }
        }

        function editUser() {
            // 禁用所有单选按钮
            var radioButtons = document.getElementsByName('keyword');
            for (var i = 0; i < radioButtons.length; i++) {
                radioButtons[i].disabled = true;
            }
            radioButtonStatus = true;

            var selectedRow = document.querySelector('input[name="keyword"]:checked').parentNode.parentNode;
            var nameCell = selectedRow.cells[1];
            var accountCell = selectedRow.cells[2];
            var passwordCell = selectedRow.cells[3];

            // 显示输入框并将内容设置为当前值
            nameCell.querySelector('span').classList.add('d-none');
            nameCell.querySelector('input').classList.remove('d-none');
            nameCell.querySelector('input').value = nameCell.querySelector('span').textContent;

            accountCell.querySelector('span').classList.add('d-none');
            accountCell.querySelector('input').classList.remove('d-none');
            accountCell.querySelector('input').value = accountCell.querySelector('span').textContent;

            passwordCell.querySelector('span').classList.add('d-none');
            passwordCell.querySelector('input').classList.remove('d-none');
            passwordCell.querySelector('input').value = passwordCell.querySelector('span').textContent;

            // 隐藏编辑按钮，显示完成按钮
            document.getElementById('editButton').classList.add('d-none');
            document.getElementById('addButton').classList.add('d-none');
            document.getElementById('deleteButton').classList.add('d-none');
            document.getElementById('saveButton').classList.remove('d-none');
        }

        function saveUser() {
            // 恢复所有单选按钮的状态
            var radioButtons = document.getElementsByName('keyword');
            for (var i = 0; i < radioButtons.length; i++) {
                radioButtons[i].disabled = radioButtonStatus;
            }

            var selectedRow = document.querySelector('input[name="keyword"]:checked').parentNode.parentNode;
            var nameCell = selectedRow.cells[1];
            var accountCell = selectedRow.cells[2];
            var passwordCell = selectedRow.cells[3];

            var newName = nameCell.querySelector('input').value;
            var newAccount = accountCell.querySelector('input').value;
            var newPassword = passwordCell.querySelector('input').value;

            if (newName === '' || newAccount === '' || newPassword === '') {
                // 显示模态框或其他错误处理逻辑
                $('#errorModal').modal('show');
                return;
            }

            var radioButtons = document.getElementsByName('keyword');
            for (var i = 0; i < radioButtons.length; i++) {
                radioButtons[i].disabled = false;
            }

            nameCell.querySelector('span').textContent = newName;
            accountCell.querySelector('span').textContent = newAccount;
            passwordCell.querySelector('span').textContent = newPassword;

            // 隐藏输入框，显示文本内容
            nameCell.querySelector('span').classList.remove('d-none');
            nameCell.querySelector('input').classList.add('d-none');

            accountCell.querySelector('span').classList.remove('d-none');
            accountCell.querySelector('input').classList.add('d-none');

            passwordCell.querySelector('span').classList.remove('d-none');
            passwordCell.querySelector('input').classList.add('d-none');

            // 隐藏完成按钮，显示编辑、新增和删除按钮
            document.getElementById('editButton').classList.remove('d-none');
            document.getElementById('addButton').classList.remove('d-none');
            document.getElementById('deleteButton').classList.remove('d-none');
            document.getElementById('saveButton').classList.add('d-none');
        }

        function addUser() {
            // 禁用所有单选按钮
            var radioButtons = document.getElementsByName('keyword');
            for (var i = 0; i < radioButtons.length; i++) {
                radioButtons[i].disabled = true;
            }

            radioButtonStatus = true;

            var newRow = document.getElementById('dataTable').insertRow(-1);

            var radioCell = newRow.insertCell(0);
            radioCell.innerHTML = '<input type="radio" name="keyword" checked>';

            var nameCell = newRow.insertCell(1);
            nameCell.innerHTML = '<span></span><input type="text" class="form-control" name="new_name">';

            var accountCell = newRow.insertCell(2);
            accountCell.innerHTML = '<span></span><input type="text" class="form-control" name="new_account">';

            var passwordCell = newRow.insertCell(3);
            passwordCell.innerHTML = '<span></span><input type="text" class="form-control" name="new_password">';

            // 隐藏编辑按钮，显示完成按钮
            document.getElementById('editButton').classList.add('d-none');
            document.getElementById('addButton').classList.add('d-none');
            document.getElementById('deleteButton').classList.add('d-none');
            document.getElementById('saveButton').classList.remove('d-none');
        }

        function deleteUser() {
            var selectedRow = document.querySelector('input[name="keyword"]:checked').parentNode.parentNode;
            selectedRow.parentNode.removeChild(selectedRow);
            var keyword = selectedRow.cells[1].querySelector('span').textContent;

            // 使用fetch发送异步请求到后端
            fetch('/websites/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ keyword: keyword })
            })
            .then(response => {
                if (response.ok) {
                    selectedRow.parentNode.removeChild(selectedRow);
                } else {
                    throw new Error('删除请求失败');
                }
            })
            .catch(error => {
                console.error(error);
                // 处理错误
            });

            // 隐藏完成按钮，显示编辑、新增和删除按钮
            document.getElementById('editButton').classList.remove('d-none');
            document.getElementById('addButton').classList.remove('d-none');
            document.getElementById('deleteButton').classList.remove('d-none');
            document.getElementById('saveButton').classList.add('d-none');
        }
    </script>
</body>
</html>
